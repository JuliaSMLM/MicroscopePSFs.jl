<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Examples · MicroscopePSFs.jl</title><meta name="title" content="Examples · MicroscopePSFs.jl"/><meta property="og:title" content="Examples · MicroscopePSFs.jl"/><meta property="twitter:title" content="Examples · MicroscopePSFs.jl"/><meta name="description" content="Documentation for MicroscopePSFs.jl."/><meta property="og:description" content="Documentation for MicroscopePSFs.jl."/><meta property="twitter:description" content="Documentation for MicroscopePSFs.jl."/><meta property="og:url" content="https://JuliaSMLM.github.io/MicroscopePSFs.jl/examples/"/><meta property="twitter:url" content="https://JuliaSMLM.github.io/MicroscopePSFs.jl/examples/"/><link rel="canonical" href="https://JuliaSMLM.github.io/MicroscopePSFs.jl/examples/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">MicroscopePSFs.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../interface/">Interface</a></li><li><a class="tocitem" href="../conventions/">Conventions</a></li><li><span class="tocitem">PSF Types</span><ul><li><a class="tocitem" href="../psfs/overview/">Overview</a></li><li><a class="tocitem" href="../psfs/gaussianpsf/">GaussianPSF</a></li><li><a class="tocitem" href="../psfs/airypsf/">AiryPSF</a></li><li><a class="tocitem" href="../psfs/scalarpsf/">ScalarPSF</a></li><li><a class="tocitem" href="../psfs/vectorpsf/">VectorPSF</a></li><li><a class="tocitem" href="../psfs/splinepsf/">SplinePSF</a></li></ul></li><li><a class="tocitem" href="../zernike/">Zernike Polynomials</a></li><li><a class="tocitem" href="../io/">I/O Functionality</a></li><li class="is-active"><a class="tocitem" href>Examples</a><ul class="internal"><li><a class="tocitem" href="#Rendering-a-Camera-Image-as-a-Heatmap"><span>Rendering a Camera Image as a Heatmap</span></a></li><li><a class="tocitem" href="#Generate-a-Simulation-with-Multiple-Emitters"><span>Generate a Simulation with Multiple Emitters</span></a></li><li><a class="tocitem" href="#Model-a-PSF-Measurement-with-Stage-Movement"><span>Model a PSF Measurement with Stage Movement</span></a></li><li><a class="tocitem" href="#Example-of-Using-Enzyme-to-Differentiate-a-PSF"><span>Example of Using Enzyme to Differentiate a PSF</span></a></li><li><a class="tocitem" href="#CRLB-Calculation-Example"><span>CRLB Calculation Example</span></a></li></ul></li><li><a class="tocitem" href="../api/">API Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Examples</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Examples</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaSMLM/MicroscopePSFs.jl/blob/main/docs/src/examples.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Examples"><a class="docs-heading-anchor" href="#Examples">Examples</a><a id="Examples-1"></a><a class="docs-heading-anchor-permalink" href="#Examples" title="Permalink"></a></h1><p>This page provides practical examples demonstrating common use cases of MicroscopePSFs.jl.</p><h2 id="Rendering-a-Camera-Image-as-a-Heatmap"><a class="docs-heading-anchor" href="#Rendering-a-Camera-Image-as-a-Heatmap">Rendering a Camera Image as a Heatmap</a><a id="Rendering-a-Camera-Image-as-a-Heatmap-1"></a><a class="docs-heading-anchor-permalink" href="#Rendering-a-Camera-Image-as-a-Heatmap" title="Permalink"></a></h2><p>To render an image so that it matches the coordinate system used by cameras, we need to place the (1,1) pixel at the top left corner and have the <span>$y$</span> axis descend. Note the deliberate use of a non-square camera pixel array to demonstrate the coordinate system.</p><pre><code class="language-julia hljs">using MicroscopePSFs
using CairoMakie
using Enzyme

# Create a psf
psf = AiryPSF(1.4, 0.532)

# Setup camera
nx, ny, pixel_size = 20, 10, 0.05  # 100 nm pixels
camera = IdealCamera(nx, ny, pixel_size)

# Render an image with a single emitter
x_microns, y_microns, photons = 0.5, 0.25, 1000.0  # Emitter position and brightness
image = integrate_pixels(psf, camera, Emitter2D(x_microns, y_microns, photons))

# Show image as a heatmap with pixel (1,1) at top left and y axis descending
fig = Figure()
ax = Axis(fig[1, 1], yreversed=true, aspect=DataAspect())
heatmap!(ax, image&#39;, colormap=:inferno)
display(fig)
save(&quot;camera_heatmap.png&quot;, fig)</code></pre><p><img src="../camera_heatmap.png" alt/></p><h2 id="Generate-a-Simulation-with-Multiple-Emitters"><a class="docs-heading-anchor" href="#Generate-a-Simulation-with-Multiple-Emitters">Generate a Simulation with Multiple Emitters</a><a id="Generate-a-Simulation-with-Multiple-Emitters-1"></a><a class="docs-heading-anchor-permalink" href="#Generate-a-Simulation-with-Multiple-Emitters" title="Permalink"></a></h2><p>This example demonstrates how to simulate an image with multiple emitters very quickly. This could be used to simulate large data sets of SMLM data. It makes use of the SplinePSF and finite support regions. </p><pre><code class="language-julia hljs">using MicroscopePSFs
using CairoMakie
using Enzyme

# Create a psf with astigmatism
zc = ZernikeCoefficients(15)
zc.phase[6] = 0.5  # Add vertical astigmatism
psf = ScalarPSF(1.4, 0.532, 1.52; zernike_coeffs=zc)

# Create SplinePSF for speed. This is the slowest part of the simulation.
xy_sampling, z_sampling = 0.05, 0.1
x_range = y_range = -1.0:xy_sampling:1.0
z_range = -1.0:xy_sampling:1.0
psf_spline = SplinePSF(psf, x_range, y_range, z_range)

# Setup camera
nx, ny, pixel_size = 128, 128, 0.1  # 100 nm pixels
camera = IdealCamera(nx, ny, pixel_size)

# Create emitters
n_emitters = 5.0 * (nx * ny * pixel_size^2)  # 5 μm^-2 of emitter density
emitters = [Emitter3D(nx * pixel_size * rand(), ny * pixel_size * rand(), rand()-0.5, 1000.0)
    for _ in 1:n_emitters]

# Render the image using region of support option
image = integrate_pixels(psf_spline, camera, emitters; support=0.5)


fig = Figure()
ax = Axis(fig[1, 1], yreversed=true, aspect=DataAspect())
heatmap!(ax, image&#39;, colormap=:inferno)
hidedecorations!(ax)
display(fig)
save(&quot;camera_multi_emitters.png&quot;, fig)</code></pre><p><img src="../camera_multi_emitters.png" alt/></p><h2 id="Model-a-PSF-Measurement-with-Stage-Movement"><a class="docs-heading-anchor" href="#Model-a-PSF-Measurement-with-Stage-Movement">Model a PSF Measurement with Stage Movement</a><a id="Model-a-PSF-Measurement-with-Stage-Movement-1"></a><a class="docs-heading-anchor-permalink" href="#Model-a-PSF-Measurement-with-Stage-Movement" title="Permalink"></a></h2><p>In the <code>VectorPSF</code> model, moving the stage and moving the emitter are not equivalent. This example demonstrates how to simulate a series of images with the stage moving in the <span>$z$</span> direction, while the emitter stays fixed on the coverslip.  This is a common experimental prodecure to measure microscope PSFs.</p><pre><code class="language-julia hljs">using MicroscopePSFs
using CairoMakie
using Enzyme

# Create a Vector PSF with x-dipole
dipole = DipoleVector(1.0, 0.0, 0.0)  # x-dipole
emitter = Emitter3D(0.5, 0.5, 0.0, 1000.0)  # Emitter on coverslip

# Setup camera
nx, ny, pixel_size = 20, 20, 0.05  # 100 nm pixels
camera = IdealCamera(nx, ny, pixel_size)

z_stack = Vector{Array{Float64}}()

# Loop over z_stage positions
stage_positions = -1.0:0.5:1.0  # Z stage positions in microns
for z_stage in stage_positions
    # Create a VectorPSF with the current z_stage position
    psf = VectorPSF(1.4, 0.690, dipole; z_stage=z_stage)

    # Integrate over the camera pixels
    image = integrate_pixels(psf, camera, emitter)

    # Store the image in the z_stack
    push!(z_stack, image)
end

fig = Figure()
for (i, image) in enumerate(z_stack)
    ax = Axis(fig[1, i], yreversed=true, aspect=DataAspect(), title=&quot;$(stage_positions[i]) μm&quot;)
    heatmap!(ax, image&#39;, colormap=:inferno)
    hidedecorations!(ax)
end
display(fig)
save(&quot;camera_z_stack_stage.png&quot;, fig)</code></pre><p><img src="../camera_z_stack_stage.png" alt/></p><h2 id="Example-of-Using-Enzyme-to-Differentiate-a-PSF"><a class="docs-heading-anchor" href="#Example-of-Using-Enzyme-to-Differentiate-a-PSF">Example of Using Enzyme to Differentiate a PSF</a><a id="Example-of-Using-Enzyme-to-Differentiate-a-PSF-1"></a><a class="docs-heading-anchor-permalink" href="#Example-of-Using-Enzyme-to-Differentiate-a-PSF" title="Permalink"></a></h2><p>We can differentiate both the <code>psf(x, y, z)</code> and the <code>integrate_pixels(psf, camera, emitter)</code> functions using Enzyme.jl.  </p><h3 id="PSF-Derivatives"><a class="docs-heading-anchor" href="#PSF-Derivatives">PSF Derivatives</a><a id="PSF-Derivatives-1"></a><a class="docs-heading-anchor-permalink" href="#PSF-Derivatives" title="Permalink"></a></h3><pre><code class="language-julia hljs">using MicroscopePSFs
using CairoMakie
using Enzyme

# Camera setup
nx, ny, pixel_size = 20, 20, 0.1  # 100 nm pixels
camera = IdealCamera(nx, ny, pixel_size)
camera = IdealCamera(nx, ny, pixel_size)

# Create PSF with astigmatism
zc = ZernikeCoefficients(15)
zc.phase[6] = 0.5  # Add vertical astigmatism
psf = ScalarPSF(1.2, 0.6, 1.33; zernike_coeffs=zc)

# Calc derivative image
x_range = y_range = range(-0.5, 0.5, 40)  # PSF field coordinates

# Calculate the PSF and its derivatives using Enzyme
dx_values = [Enzyme.autodiff(Enzyme.Reverse, x -&gt; psf(x, y, 0.0), Active, Active(x))[1][1] for x in x_range, y in y_range]
dy_values = [Enzyme.autodiff(Enzyme.Reverse, y -&gt; psf(x, y, 0.0), Active, Active(y))[1][1] for x in x_range, y in y_range]
dz_values = [Enzyme.autodiff(Enzyme.Reverse, z -&gt; psf(x, y, z), Active, Active(0.0))[1][1] for x in x_range, y in y_range]
psf_arr = [psf(x, y, 0.0) for x in x_range, y in y_range]

# Plot with CairoMakie
fig = Figure()
ax = Axis(fig[1, 1], title = &quot;PSF&quot;, yreversed=true, aspect=DataAspect())
heatmap!(ax, psf_arr&#39;)
hidedecorations!(ax)
ax2 = Axis(fig[1, 2], title = &quot;dPSF/dx&quot;, yreversed=true, aspect=DataAspect())
heatmap!(ax2, dx_values&#39;)
hidedecorations!(ax2)
ax3 = Axis(fig[1, 3], title = &quot;dPSF/dy&quot;, yreversed=true, aspect=DataAspect())
heatmap!(ax3, dy_values&#39;)
ax4 = Axis(fig[1, 4], title = &quot;dPSF/dz&quot;, yreversed=true, aspect=DataAspect())
hidedecorations!(ax4)
heatmap!(ax4, dz_values&#39;)
display(fig)
save(&quot;psf_derivatives.png&quot;, fig)</code></pre><p><img src="../psf_derivatives.png" alt/></p><h3 id="Integrated-PSF-Derivatives"><a class="docs-heading-anchor" href="#Integrated-PSF-Derivatives">Integrated PSF Derivatives</a><a id="Integrated-PSF-Derivatives-1"></a><a class="docs-heading-anchor-permalink" href="#Integrated-PSF-Derivatives" title="Permalink"></a></h3><pre><code class="language-julia hljs">using MicroscopePSFs
using CairoMakie
using Enzyme

# Setup camera
nx, ny, pixel_size = 20, 20, 0.1  # 100 nm pixels
camera = IdealCamera(nx, ny, pixel_size)

# Create PSF with astigmatism
zc = ZernikeCoefficients(15)
zc.phase[6] = 0.5  # Add vertical astigmatism
psf = ScalarPSF(1.2, 0.6, 1.33; zernike_coeffs=zc)

x_emitter = y_emitter = nx / 2 * pixel_size
z_emitter, photons = 0.0, 1000.0

# Use jacobian since our output is a 2D image
dx_image = Enzyme.jacobian(set_runtime_activity(Enzyme.Forward),
    x -&gt; integrate_pixels(psf, camera, Emitter3D(x, y_emitter, z_emitter, photons)),
    x_emitter)[1]
dy_image = Enzyme.jacobian(set_runtime_activity(Enzyme.Forward),
    y -&gt; integrate_pixels(psf, camera, Emitter3D(x_emitter, y, z_emitter, photons)),
    y_emitter)[1]
dz_image = Enzyme.jacobian(set_runtime_activity(Enzyme.Forward),
    z -&gt; integrate_pixels(psf, camera, Emitter3D(x_emitter, y_emitter, z, photons)),
    z_emitter)[1]
psf_image = integrate_pixels(psf, camera, Emitter3D(x_emitter, y_emitter, z_emitter, photons))

# Plot with CairoMakie
fig2 = Figure()
ax5 = Axis(fig2[1, 1], title = &quot;Integrated PSF&quot;, yreversed=true, aspect=DataAspect())
heatmap!(ax5, psf_image&#39;)
hidedecorations!(ax5)
ax6 = Axis(fig2[1, 2], title = &quot;dPSF/dx&quot;, yreversed=true, aspect=DataAspect())
heatmap!(ax6, dx_image&#39;)
hidedecorations!(ax6)
ax7 = Axis(fig2[1, 3], title = &quot;dPSF/dy&quot;, yreversed=true, aspect=DataAspect())
heatmap!(ax7, dy_image&#39;)
hidedecorations!(ax7)
ax8 = Axis(fig2[1, 4], title = &quot;dPSF/dz&quot;, yreversed=true, aspect=DataAspect())
heatmap!(ax8, dz_image&#39;)
hidedecorations!(ax8)
display(fig2)
save(&quot;psf_integrated_derivatives.png&quot;, fig2)</code></pre><p><img src="../psf_integrated_derivatives.png" alt/></p><h2 id="CRLB-Calculation-Example"><a class="docs-heading-anchor" href="#CRLB-Calculation-Example">CRLB Calculation Example</a><a id="CRLB-Calculation-Example-1"></a><a class="docs-heading-anchor-permalink" href="#CRLB-Calculation-Example" title="Permalink"></a></h2><p>We can use the derivatives from autodiff to calculate CRLBs. </p><pre><code class="language-julia hljs">using MicroscopePSFs
using Enzyme
using CairoMakie
using LinearAlgebra

function crlb_poisson(psf, camera, emitter)
    dx_values = Enzyme.jacobian(set_runtime_activity(Enzyme.Forward),
        Const(x -&gt; integrate_pixels(psf, camera, Emitter3D(x, emitter.y, emitter.z, emitter.photons))),
        emitter.x)[1]
    dy_values = Enzyme.jacobian(set_runtime_activity(Enzyme.Forward),
        Const(y -&gt; integrate_pixels(psf, camera, Emitter3D(emitter.x, y, emitter.z, emitter.photons))),
        emitter.y)[1]
    dz_values = Enzyme.jacobian(set_runtime_activity(Enzyme.Forward),
        Const(z -&gt; integrate_pixels(psf, camera, Emitter3D(emitter.x, emitter.y, z, emitter.photons))),
        emitter.z)[1]

    image = integrate_pixels(psf, camera, Emitter3D(emitter.x, emitter.y, emitter.z, emitter.photons)) .+ eps()

    # Calculate the FI matrix
    fi_matrix = zeros(3, 3)
    fi_matrix[1, 1] = sum(dx_values .^ 2 ./ image)
    fi_matrix[2, 1] = fi_matrix[1, 2] = sum(dx_values .* dy_values ./ image)
    fi_matrix[3, 1] = fi_matrix[1, 3] = sum(dx_values .* dz_values ./ image)
    fi_matrix[2, 2] = sum(dy_values .^ 2 ./ image)
    fi_matrix[3, 2] = fi_matrix[2, 3] = sum(dy_values .* dz_values ./ image)
    fi_matrix[3, 3] = sum(dz_values .^ 2 ./ image)

    # Calculate the CRLB
    crlb_matrix = inv(fi_matrix)  # Inverse of the FI matrix

    return diag(crlb_matrix)  # Return the diagonal elements (CRLB for x, y, z)
end

# Setup camera
nx, ny, pixel_size = 20, 20, 0.1  # 100 nm pixels
camera = IdealCamera(nx, ny, pixel_size)

# Setup psf
zc = ZernikeCoefficients(15)
zc.phase[6] = 0.5  # Add vertical astigmatism
psf = ScalarPSF(1.2, 0.6, 1.33; zernike_coeffs=zc)

# Setup emitter
x_emitter = y_emitter = nx / 2 * pixel_size
z_emitter, photons = 0.0, 1000.0

# Loop over z positions
z_range = -1.0:0.05:1.0  # Z stage positions in microns
σ_x = Vector{Float64}(undef, length(z_range))
σ_y = Vector{Float64}(undef, length(z_range))
σ_z = Vector{Float64}(undef, length(z_range))

for (i, z) in enumerate(z_range)
    # Create a new emitter with the current z position
    emitter = Emitter3D(x_emitter, y_emitter, z, photons)

    # Calculate the CRLB for the current emitter position
    crlb_values = crlb_poisson(psf, camera, emitter)

    σ_x[i] = sqrt(crlb_values[1])
    σ_y[i] = sqrt(crlb_values[2])
    σ_z[i] = sqrt(crlb_values[3])
end

# Plot with CairoMakie
fig = Figure()
ax = Axis(fig[1, 1], title = &quot;CRLB&quot;, xlabel=&quot;z (μm)&quot;, ylabel=&quot;σ (μm)&quot;)
lines!(ax, z_range, σ_x, label=&quot;σ_x&quot;, color=:red)
lines!(ax, z_range, σ_y, label=&quot;σ_y&quot;, color=:blue)
lines!(ax, z_range, σ_z, label=&quot;σ_z&quot;, color=:green)
axislegend(ax)
display(fig)
save(&quot;crlb.png&quot;, fig)</code></pre><p><img src="../crlb.png" alt/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../io/">« I/O Functionality</a><a class="docs-footer-nextpage" href="../api/">API Reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.10.2 on <span class="colophon-date" title="Monday 5 May 2025 23:13">Monday 5 May 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
